<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
   <section class="hero border-bottom">
    <div class="hero-body">
        <div class="container">
            <div class="is-flex is-align-items-center">
                
                <div class="mr-5">
                    <img src="/css/images/MGIS-logo_gris.png" alt="MundoGIS Logo" class="header-logo">
                </div>

                <div class="hero-text">
                    <h1 class="title">OpenFME-Scheduler</h1>
                    <h2 class="subtitle">Schedule and manage the execution of your FME scripts.</h2>
                </div>

            </div>
        </div>
    </div>
</section>

    <section class="section">
        <div class="container">
            <div class="card">
                <header class="card-header"><p class="card-header-title">Add New FME Job</p></header>
                <div class="card-content">
                    <form id="schedule-form" enctype="multipart/form-data">
                        <!-- Script Selection (unchanged) -->
                        <div class="field"><label class="label">1. Select an FME Script</label><p class="help mb-2">Choose an existing script or upload a new one from your computer.</p><div class="control"><div class="select is-fullwidth"><select id="scriptName" name="scriptName"><option value="">Loading existing scripts...</option></select></div></div></div>
                        <div class="field"><label class="label">Or Upload a New Script (.fmw)</label><div class="control"><div class="file has-name is-fullwidth"><label class="file-label"><input class="file-input" type="file" name="fmeFile" id="fmeFile" accept=".fmw"><span class="file-cta"><span class="file-icon"><i class="fas fa-upload"></i></span><span class="file-label">Choose a file…</span></span><span class="file-name" id="fileNameDisplay">No file selected.</span></label></div></div></div>
                        <hr>
                        <!-- UPDATED SCHEDULING SECTION -->
                        <label class="label">2. Specify Time and Frequency</label>
                        <div class="columns">
                            <div class="column is-half">
                                <div class="field">
                                    <label class="label is-small" for="runTime">First Run (Date and Time)</label>
                                    <div class="control"><input class="input" type="datetime-local" id="runTime" name="runTime" required></div>
                                    <p class="help">Date and time for the first (or only) run.</p>
                                </div>
                            </div>
                            <div class="column is-half">
                                <div class="field">
                                    <label class="label is-small">Frequency</label>
                                    <div class="control"><div class="select is-fullwidth"><select id="recurrenceType" name="recurrenceType"><option value="once" selected>Once</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="monthly">Monthly</option></select></div></div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Options (Hidden by Default) -->
                        <div id="recurrenceOptions" style="display: none;">
                            <div id="recurrenceTimeOptions" class="field" style="display: none;">
                                <label class="label is-small">Time for Recurrence</label>
                                <div class="control"><input class="input" type="time" id="recurrenceTime" name="recurrenceTime"></div>
                                <p class="help">Specify the time for recurring runs (leave blank to use the time from "First Run").</p>
                            </div>
                            <div id="weeklyOptions" class="field" style="display: none;">
                                <label class="label is-small">Run on the Following Days</label>
                                <div class="control field is-grouped is-grouped-multiline">
                                    <label class="checkbox control"><input type="checkbox" name="daysOfWeek" value="1"> Mon</label>
                                    <label class="checkbox control"><input type="checkbox" name="daysOfWeek" value="2"> Tue</label>
                                    <label class="checkbox control"><input type="checkbox" name="daysOfWeek" value="3"> Wed</label>
                                    <label class="checkbox control"><input type="checkbox" name="daysOfWeek" value="4"> Thu</label>
                                    <label class="checkbox control"><input type="checkbox" name="daysOfWeek" value="5"> Fri</label>
                                    <label class="checkbox control"><input type="checkbox" name="daysOfWeek" value="6"> Sat</label>
                                    <label class="checkbox control"><input type="checkbox" name="daysOfWeek" value="0"> Sun</label>
                                </div>
                            </div>
                            <div id="monthlyOptions" class="field" style="display: none;">
                                <label class="label is-small">Run on Day of the Month</label>
                                <div class="control"><input class="input" type="number" id="dayOfMonth" name="dayOfMonth" min="1" max="31" placeholder="Ex: 15 (for the 15th of each month)"></div>
                            </div>
                        </div>
                        <div class="control mt-5"><button type="submit" class="button is-info is-fullwidth">Schedule Job</button></div>
                    </form>
                </div>
            </div>
            <!-- Jobs Table (with updated header) -->
            <div class="table-container">
                 <h3 class="title is-4">Scheduled Jobs</h3>
                 <table class="table is-fullwidth is-striped is-hoverable">
                     <thead>
                         <tr>
                             <th>FME Script</th>
                             <th>First Run</th>
                             <th>Frequency</th>
                             <th>Status</th>
                             <th>Action</th>
                         </tr>
                     </thead>
                     <tbody id="jobs-table-body">
    <% if (jobs && jobs.length > 0) { %>
        <% jobs.forEach(function(job) { %>
            <tr>
                <td><%= job.scriptName %></td>
                <td><%= job.runTime %></td>
                <td><%= job.isRecurrent ? (job.recurrence?.type || 'Recurring') : 'Once' %></td>
                <td><%= job.status %></td>
                <td>
                    <button class="button is-small is-primary run-script-btn" data-script="<%= job.scriptName %>">Run</button>
                </td>
            </tr>
        <% }) %>
    <% } else { %>
        <tr><td colspan="5" class="has-text-centered">No scheduled jobs found.</td></tr>
    <% } %>
</tbody>
                 </table>
            </div>
            <!-- Log Viewer (unchanged) -->
            <div id="log-viewer" class="mt-6">
                <h3 class="title is-4">Log Viewer</h3>
                <div class="field is-grouped">
                    <div class="control is-expanded"><div class="select is-fullwidth"><select id="log-file-select"><option>Loading log list...</option></select></div></div>
                    <div class="control"><button class="button is-info" id="refresh-logs-btn"><span class="icon is-small"><i class="fas fa-sync-alt"></i></span><span>Refresh</span></button></div>
                </div>
                <div class="box" style="background-color: #2d2d2d; color: #f1f1f1; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto;">
                    <pre id="log-content">Select a log file to view its content.</pre>
                </div>
            </div>
        </div>
    </section>
    <footer class="footer">
        <div class="content has-text-centered">
            <p>© 2026 MundoGIS</p>
            <p><a href="mailto:abel.gonzalez@mundogis.se">Mundogis.se - Get in contact</a></p>
        </div>
    </footer>
    <script src="/js/script.js"></script>
    <script>
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('run-script-btn')) {
                const scriptName = event.target.dataset.script;
                fetch('/api/run-script', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scriptName })
                })
                .then(response => response.json())
                .then(data => alert(data.message))
                .catch(error => alert('Error executing script: ' + error));
            }
        });
    </script>
</body>
</html>

